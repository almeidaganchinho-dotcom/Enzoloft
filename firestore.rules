rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null;
    }

    function isValidDateString(value) {
      return value is string && value.matches('^\\d{4}-\\d{2}-\\d{2}$');
    }

    function isValidIsoDateTimeString(value) {
      return value is string && value.matches('^\\d{4}-\\d{2}-\\d{2}T.*Z$');
    }

    function isValidEmail(value) {
      return value is string
        && value.size() >= 5
        && value.size() <= 120
        && value.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$');
    }

    function isValidPhone(value) {
      return value is string
        && value.size() >= 9
        && value.size() <= 25
        && value.matches('^[0-9+()\\-\\s]+$');
    }

    function hasValidVoucher() {
      return !request.resource.data.keys().hasAny(['voucher'])
        || (
          request.resource.data.voucher is map
          && request.resource.data.voucher.keys().hasOnly(['code', 'discount', 'originalPrice'])
          && request.resource.data.voucher.code is string
          && request.resource.data.voucher.code.size() >= 3
          && request.resource.data.voucher.code.size() <= 40
          && request.resource.data.voucher.discount is number
          && request.resource.data.voucher.discount >= 0
          && request.resource.data.voucher.discount <= 20000
          && request.resource.data.voucher.originalPrice is number
          && request.resource.data.voucher.originalPrice >= 0
          && request.resource.data.voucher.originalPrice <= 20000
          && request.resource.data.voucher.originalPrice >= request.resource.data.totalPrice
        );
    }

    function isValidPublicReservationCreate() {
      return request.resource.data.keys().hasOnly([
        'propertyId',
        'guestName',
        'guestEmail',
        'guestPhone',
        'startDate',
        'endDate',
        'guestsCount',
        'totalPrice',
        'status',
        'createdAt',
        'voucher'
      ])
      && request.resource.data.propertyId is string
      && request.resource.data.propertyId.size() >= 1
      && request.resource.data.propertyId.size() <= 30
      && request.resource.data.guestName is string
      && request.resource.data.guestName.size() >= 3
      && request.resource.data.guestName.size() <= 120
      && isValidEmail(request.resource.data.guestEmail)
      && isValidPhone(request.resource.data.guestPhone)
      && isValidDateString(request.resource.data.startDate)
      && isValidDateString(request.resource.data.endDate)
      && request.resource.data.endDate > request.resource.data.startDate
      && request.resource.data.guestsCount is int
      && request.resource.data.guestsCount >= 1
      && request.resource.data.guestsCount <= 20
      && request.resource.data.totalPrice is number
      && request.resource.data.totalPrice > 0
      && request.resource.data.totalPrice <= 20000
      && request.resource.data.status == 'pending'
      && isValidIsoDateTimeString(request.resource.data.createdAt)
      && hasValidVoucher();
    }

    function isValidPublicSiteStatsWrite() {
      return request.resource.data.keys().hasOnly(['totalVisits', 'lastVisitAt'])
      && request.resource.data.totalVisits is number
      && request.resource.data.lastVisitAt is string;
    }
    
    // Reservations
    match /reservations/{reservationId} {
      // Público só pode ler reservas confirmadas (ex.: bloqueio de datas no frontend)
      allow read: if isAdmin() || resource.data.status == 'confirmed';
      // Público pode criar pedidos de reserva com validação mínima
      allow create: if isValidPublicReservationCreate() || isAdmin();
      // Atualizações e remoções apenas admin autenticado
      allow update, delete: if isAdmin();
    }
    
    // Prices
    match /prices/{priceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Availability
    match /availability/{availabilityId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Vouchers
    match /vouchers/{voucherId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings - regra específica para contador público de visitas
    match /settings/siteStats {
      allow read: if true;
      allow create, update: if isAdmin() || isValidPublicSiteStatsWrite();
      allow delete: if isAdmin();
    }
    
    // Settings gerais
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Visit events - escrita pública, leitura apenas admin
    match /visitEvents/{eventId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Client events - escrita pública, leitura apenas admin
    match /clientEvents/{eventId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }
  }
}
